# Detailed Usage Guide

This guide provides comprehensive instructions for using LaTeX to DOCX Converter.

## Table of Contents

1. [Basic Usage](#basic-usage)
2. [Script-by-Script Guide](#script-by-script-guide)
3. [Troubleshooting](#troubleshooting)
4. [Customization](#customization)
5. [Configuration Files](#configuration-files)

## Basic Usage

### Quick Start

```bash
# Pattern 1: Default settings (main.tex → output_YYYYMMDD.docx)
cd your-project-dir
/path/to/latex2docx-converter/src/convert_latex_to_docx.sh

# Pattern 2: Specify input file
/path/to/latex2docx-converter/src/convert_latex_to_docx.sh mydoc.tex

# Pattern 3: Specify both input and output
/path/to/latex2docx-converter/src/convert_latex_to_docx.sh input.tex output.docx
```

### Recommended Directory Structure

```
your-project/
├── main.tex                 # Main LaTeX file
├── data/                    # External data files (CSV, etc.)
│   └── sample.dat
├── figures/                 # Figure sources (EPS, etc.)
│   └── sample.eps
└── sections/                # Subsections (\input references)
    ├── 01-intro.tex
    ├── 02-methods.tex
    └── 03-results.tex
```

**Important:** Always run conversion scripts from the same directory as main.tex. This ensures external file references are resolved correctly.

## Script-by-Script Guide

### 1. convert_latex_to_docx.sh (Main Script)

Executes the entire conversion process in one command.

#### Usage

```bash
./src/convert_latex_to_docx.sh [input_file] [output_file]
```

#### Parameters

| Argument | Description | Default |
|----------|-------------|---------|
| input_file | Input LaTeX file | main.tex |
| output_file | Output docx file | output_YYYYMMDD.docx |

#### Output Files

```
your-project/
├── main_pandoc.tex              # Preprocessed file
├── main_with_images.tex         # Image-replaced file
├── output_20260115.docx         # Final output (Word format)
├── tikz_extracted/              # Extracted TikZ figures
│   ├── shapes.tex
│   ├── plot.tex
│   └── data/                    # Copy of data directory
├── tikz_png/                    # Generated PNG images
│   ├── shapes.png
│   └── plot.png
├── compile.log                  # TikZ compilation log
└── pandoc_conversion.log        # Pandoc conversion log
```

### 2. preprocess.py

Converts custom LaTeX commands to standard commands.

#### Usage

```bash
python3 src/preprocess.py [input_file] [output_file]
```

#### Supported Conversions

| Input | Output | Package |
|-------|--------|---------|
| `\ab(x)` | `\left(x\right)` | physics2 |
| `\ab\|x\|` | `\left\|x\right\|` | physics2 |
| `\ab{x}` | `\left\{x\right\}` | physics2 |

#### Nested Bracket Support

```latex
% Input
\ab(\ab(a) + b)

% Output
\left(\left(a\right) + b\right)
```

Supports up to 50 levels of nesting through iterative processing.

### 3. extract_tikz_improved.py

Extracts TikZ figures from LaTeX files.

#### Usage

```bash
python3 src/extract_tikz_improved.py [input_file]
```

#### Automatic Label Detection

The script automatically detects `\label{fig:...}` commands in your LaTeX file:

```latex
\begin{figure}
\begin{tikzpicture}
  % TikZ code
\end{tikzpicture}
\caption{Sample figure}
\label{fig:sample-diagram}
\end{figure}
```

The extracted file will be named `tikz_extracted/sample-diagram.tex`.

#### Data Directory Auto-copy

If a `data/` directory exists, it's automatically copied to `tikz_extracted/data/`. This enables TikZ code that references `table {data/sample.dat}` to compile correctly.

### 4. compile_tikz_labeled.sh

Compiles TikZ figures to PNG images.

#### Usage

```bash
./src/compile_tikz_labeled.sh
```

#### Processing

1. Compiles each `.tex` file in `tikz_extracted/` using pdflatex
2. Converts generated PDFs to PNG at 300 dpi using ImageMagick

#### Troubleshooting Compilation

**On compilation failure:**

```bash
# Check compilation log
cat compile.log
```

**Common Issues:**

| Problem | Cause | Solution |
|---------|-------|----------|
| `! Package pgfplots Error` | pgfplots not installed | `tlmgr install pgfplots` |
| `! Undefined control sequence` | Missing package support | See [Customization](#customization) |
| PNG generation fails | ImageMagick not installed | `sudo apt install imagemagick` |

### 5. replace_tikz_labeled.py

Replaces TikZ environments with `\includegraphics` commands.

#### Usage

```bash
python3 src/replace_tikz_labeled.py [input_file] [output_file]
```

#### Processing Example

```latex
% Input (main_pandoc.tex)
\begin{tikzpicture}
  \draw (0,0) rectangle (2,1);
\end{tikzpicture}

% Output (main_with_images.tex)
\begin{center}
\includegraphics[width=0.8\textwidth]{tikz_png/sample-diagram.png}
\end{center}
```

### 6. clean.sh

Removes all intermediate files generated by the converter.

#### Usage

```bash
./src/clean.sh
```

#### Removes

- `tikz_extracted/` directory
- `tikz_png/` directory
- `*_pandoc.tex`, `*_with_images.tex` files
- `*.docx` files
- Log files (`compile.log`, `pandoc_conversion.log`)

## Troubleshooting

### Common Issues and Solutions

#### 1. TikZ Compilation Fails

**Symptom:** Step [3/5] fails

**Solution:**

```bash
# 1. Check the log
cat compile.log | tail -20

# 2. Install missing packages
tlmgr install pgfplots amsmath amssymb

# 3. Retry
./src/compile_tikz_labeled.sh
```

#### 2. Pandoc Conversion Fails

**Symptom:** Step [5/5] fails

**Solution:**

```bash
# 1. Check the log
cat pandoc_conversion.log

# 2. Verify Pandoc version (need 2.0+)
pandoc --version

# 3. Verify image and data directories exist
ls -la tikz_png/
ls -la data/

# 4. Retry
./src/convert_latex_to_docx.sh
```

#### 3. Character Encoding Issues

**Symptom:** Japanese text appears garbled in docx

**Cause:**
- TeX file not encoded in UTF-8
- Pandoc encoding settings incorrect

**Solution:**

```bash
# Check file encoding
file main.tex

# If not UTF-8, convert:
iconv -f SJIS -t UTF-8 main.tex > main_utf8.tex
mv main_utf8.tex main.tex
```

#### 4. Images Not Embedded in DOCX

**Symptom:** Docx file has no images

**Cause:**
- TikZ compilation failed (no PNG generated)
- Incorrect image paths

**Solution:**

```bash
# Verify PNG files exist
ls -la tikz_png/

# Verify files are not empty
file tikz_png/*.png

# Test with raw LaTeX
pdflatex main_with_images.tex
```

## Customization

### Add Custom Commands

Edit `src/preprocess.py` to support additional commands:

```python
# Example: Support beamer's \alert{...}
def replace_custom_beamer(content):
    """Replace beamer commands"""
    content = re.sub(r'\\alert\{(.+?)\}', r'\\textcolor{red}{\1}', content)
    return content

# Add to process_tex_file()
content = replace_custom_beamer(content)
```

### Customize TikZ Preamble

Edit `src/extract_tikz_improved.py` to modify the TikZ preamble:

```python
standalone_content = f"""\\documentclass{{standalone}}
\\usepackage{{tikz}}
\\usepackage{{your-custom-package}}
...
"""
```

### Modify Pandoc Options

Edit `src/convert_latex_to_docx.sh` to change pandoc behavior:

```bash
# Current default
pandoc "$IMAGES_FILE" -o "${OUTPUT_FILE}" \
    --resource-path=.:tikz_png:data:figures \
    --number-sections \
    --toc \
    --standalone

# Example: Add bibliography and citation support
pandoc "$IMAGES_FILE" -o "${OUTPUT_FILE}" \
    --resource-path=.:tikz_png:data:figures \
    --toc \
    --standalone \
    --citeproc \
    --bibliography=refs.bib
```

## Configuration Files

### YAML Configuration (Planned Feature)

Future versions will support YAML configuration files:

```bash
# Planned usage (not yet implemented)
./src/convert_latex_to_docx.sh --config config.yaml
```

See `config.yaml.example` for the planned configuration format.

### Engine Selection (Planned Feature)

Future versions will support different LaTeX engines:

```bash
# Planned usage (not yet implemented)

# Use pdflatex (current default)
./src/convert_latex_to_docx.sh main.tex --engine pdflatex

# Use lualatex (future)
./src/convert_latex_to_docx.sh main.tex --engine lualatex

# Use xelatex (future)
./src/convert_latex_to_docx.sh main.tex --engine xelatex
```

## Tips and Tricks

### Handle Large TikZ Figures

For very large or complex TikZ figures:

```bash
# Option 1: Reduce PNG resolution
# Edit compile_tikz_labeled.sh and change 300 to 150 dpi

# Option 2: Break figure into multiple simpler figures
# Split one complex figure into several simpler ones

# Option 3: Use TikZ's external library
% In LaTeX preamble:
\tikzexternalize
```

### Batch Convert Multiple Documents

```bash
# Convert all TeX files in directory
for tex_file in *.tex; do
    ./src/convert_latex_to_docx.sh "$tex_file"
done
```

### Suppress PNG Embedding

If you don't want images embedded in docx:

```bash
# Skip step [4/5] and convert directly
./src/convert_latex_to_docx.sh main.tex  # Runs up to step [3/5]
# Manually run without image replacement
pandoc main_pandoc.tex -o output.docx \
    --number-sections --toc --standalone
```

## Q&A

**Q: Very large TikZ figure compiles slowly (>30 seconds)?**

A: Try these approaches:
1. Reduce PNG DPI (300→150)
2. Split complex figure into simpler ones
3. Use TikZ's `external` library for caching

**Q: Many warnings from Pandoc?**

A: Most warnings are related to Japanese text processing and can be ignored. The output is usually correct.

**Q: Can I use different LaTeX engines?**

A: Currently only pdflatex is supported. Future versions will support lualatex and xelatex. You can manually edit `compile_tikz_labeled.sh` to experiment.

**Q: How do I update just one figure?**

A: Manually edit the TikZ code in `tikz_extracted/` and re-run `./src/compile_tikz_labeled.sh`.

**Q: Which features are tested on?**

A: Currently tested on:
- Linux (Ubuntu 20.04+)
- macOS (11+)
- Bash 4.0+
- Python 3.7+
- TeX Live 2021+

---

For additional questions, please open an [Issue](https://github.com/yourusername/latex2docx-converter/issues).
